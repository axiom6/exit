// Generated by CoffeeScript 1.9.1
(function() {
  var DriveBar,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  DriveBar = (function() {
    Util.Export(DriveBar, 'ui/DriveBar');

    function DriveBar(app, stream, ext1, parent) {
      this.app = app;
      this.stream = stream;
      this.ext = ext1;
      this.parent = parent;
      this.onConditions = bind(this.onConditions, this);
      this.Data = Util.Import('app/Data');
      this.name = 'DriveBar';
      this.created = false;
    }

    DriveBar.prototype.html = function() {
      var htm;
      this.htmlId = this.app.id(this.name, this.ext);
      htm = "<div id=\"" + this.htmlId + "\" class=\"" + (this.app.css(this.name)) + "\"></div>";
      this.$ = $(htm);
      return htm;
    };

    DriveBar.prototype.ready = function() {};

    DriveBar.prototype.postReady = function() {
      var ref;
      ref = this.createSvg(this.$, this.htmlId, this.name, this.ext, this.svgWidth(), this.svgHeight(), this.barTop()), this.svg = ref[0], this.$svg = ref[1], this.g = ref[2], this.$g = ref[3], this.gw = ref[4], this.gh = ref[5], this.y0 = ref[6];
      return this.subscribe();
    };

    DriveBar.prototype.subscribe = function() {
      this.stream.subscribe('Location', (function(_this) {
        return function(object) {
          return _this.onLocation(object.content);
        };
      })(this));
      this.stream.subscribe('Orient', (function(_this) {
        return function(object) {
          return _this.layout(object.content);
        };
      })(this));
      return this.stream.subscribe('Conditions', (function(_this) {
        return function(object) {
          return _this.onConditions(object.content);
        };
      })(this));
    };

    DriveBar.prototype.onLocation = function(latlon) {
      return Util.dbg('DriveBar.onLocation()', this.ext, latlon);
    };

    DriveBar.prototype.onConditions = function(conditions) {
      if (!this.created) {
        return this.createBars(this.app.model.segments, conditions, this.Data);
      } else {
        return this.updateBars(this.app.model.segments, conditions, this.Data);
      }
    };

    DriveBar.prototype.layout = function(orientation) {
      var xs, ys;
      this.orientation = orientation;
      this.svg.attr("width", this.svgWidth()).attr('height', this.svgHeight());
      xs = this.gw > 0 ? this.gw / this.svgWidth() : 1.0;
      ys = 1.0;
      this.g.attr('transform', "scale(" + xs + "," + ys + ")");
    };

    DriveBar.prototype.svgWidth = function() {
      if (this.ext !== 'Road') {
        return this.app.width() * 0.92;
      } else {
        return 640;
      }
    };

    DriveBar.prototype.svgHeight = function() {
      if (this.ext !== 'Road') {
        return this.parent.$.height() * 0.33;
      } else {
        return 200;
      }
    };

    DriveBar.prototype.barHeight = function() {
      return this.svgHeight() * 0.33;
    };

    DriveBar.prototype.barTop = function() {
      return this.svgHeight() * 0.50;
    };

    DriveBar.prototype.createSvg = function($, htmlId, name, ext, width, height, barTop) {
      var $g, $svg, g, gId, svg, svgId;
      svgId = this.app.svgId(name, ext, 'Svg');
      gId = this.app.svgId(name, ext, 'G');
      svg = d3.select('#' + htmlId).append("svg:svg").attr("id", svgId).attr("width", width).attr("height", height);
      g = svg.append("svg:g").attr("id", gId);
      $svg = $.find('#' + svgId);
      $g = $.find('#' + gId);
      return [svg, $svg, g, $g, width, height, barTop];
    };

    DriveBar.prototype.createBars = function(segments, conditions, Data) {
      var beg, distance, end, feature, features, fill, i, len, mileBeg, mileEnd, mileRef, n, prop, pxLen, segId, thick;
      Util.dbg('createBars', this.ext);
      features = this.app.direction === 'West' ? Data.WestSegments.features : Data.EastSegments.features;
      n = features.length - 1;
      mileBeg = features[0].properties.beg;
      mileEnd = features[n].properties.end;
      mileRef = this.app.direction === 'West' ? mileBeg : mileEnd;
      distance = Math.abs(mileEnd - mileBeg);
      pxLen = this.ext !== 'Road' ? this.svgWidth() : this.app.height();
      thick = 1;
      for (i = 0, len = features.length; i < len; i++) {
        feature = features[i];
        prop = feature.properties;
        beg = pxLen * Math.abs(prop.beg - mileRef) / distance;
        end = pxLen * Math.abs(prop.end - mileRef) / distance;
        segId = Util.toInt(prop.id);
        fill = this.fillCondition(segId, conditions);
        this.rect(this.g, segId, beg, this.barTop(), end - beg, this.barHeight(), fill, 'black', thick, '');
        this.created = true;
      }
      this.rect(this.g, this.ext + 'Border', 0, this.barTop(), pxLen, this.barHeight(), 'transparent', 'white', thick * 4, '');
    };

    DriveBar.prototype.fillCondition = function(segId, conditions) {
      var Conditions;
      Conditions = this.getConditions(segId, conditions);
      if ((Conditions == null) || (Conditions.AverageSpeed == null)) {
        return 'gray';
      }
      return this.fillSpeed(Conditions.AverageSpeed);
    };

    DriveBar.prototype.getConditions = function(segId, conditions) {
      var condition, i, len;
      for (i = 0, len = conditions.length; i < len; i++) {
        condition = conditions[i];
        if ((condition.SegmentId != null) && (condition.Conditions != null)) {
          if (segId === condition.SegmentId) {
            return condition.Conditions;
          }
        }
      }
      return void 0;
    };

    DriveBar.prototype.fillSpeed = function(speed) {
      var fill;
      fill = 'gray';
      if (50 < speed) {
        fill = 'green';
      } else if (25 < speed && speed <= 50) {
        fill = 'yellow';
      } else if (15 < speed && speed <= 25) {
        fill = 'red';
      } else if (0 < speed && speed <= 15) {
        fill = 'black';
      }
      return fill;
    };

    DriveBar.prototype.updateBars = function(segments, conditions, Data) {
      var feature, features, fill, i, len, prop, segId;
      Util.dbg('updateBars', this.ext);
      features = this.app.direction === 'West' ? Data.WestSegments.features : Data.EastSegments.features;
      for (i = 0, len = features.length; i < len; i++) {
        feature = features[i];
        prop = feature.properties;
        segId = Util.toInt(prop.id);
        fill = this.fillCondition(segId, conditions);
        this.updateRectFill(segId, fill);
      }
    };

    DriveBar.prototype.rect = function(g, segId, x0, y0, w, h, fill, stroke, thick, text) {
      var svgId;
      if (text == null) {
        text = '';
      }
      svgId = this.app.svgId(this.name, segId.toString(), this.ext);
      g.append("svg:rect").attr('id', svgId).attr("x", x0).attr("y", y0).attr("width", w).attr("height", h).attr("fill", fill).attr("stroke", stroke).attr("stroke-width", thick);
      if (text !== '') {
        g.append("svg:text").text(text).attr("x", x0 + w / 2).attr("y", y0 + h / 2 + 2).attr('fill', this.textFill(fill)).attr("text-anchor", "middle").attr("font-size", "4px").attr("font-family", "Arial");
      }
    };

    DriveBar.prototype.updateRectFill = function(segId, fill) {
      var rect, rectId;
      rectId = this.app.svgId(this.name, segId.toString(), this.ext);
      rect = $svg.find('#' + rectId);
      rect.attr('fill', fill);
    };

    return DriveBar;

  })();

}).call(this);
